import{v as e,g as s,x as t,_ as l,S as a,c as o,w as c,e as i,s as n,d,n as r,a as u,y as p,h as f,z as h,A as m,B as g,C as _,D as y,i as D,j as x,o as T,k as F,l as v,m as P,E as b,u as C,t as I,G as k,H as w}from"./index-CMSmlURr.js";import{D as S}from"./fund-fields.piuN49H-.js";async function E(){const s=`${e().BASE_URL}/system/health`;return console.log("🔍 测试后端连接:",s),new Promise((e,l)=>{t({url:s,method:"GET",timeout:1e4,success:s=>{console.log("✅ 后端连接测试成功:",{statusCode:s.statusCode,data:s.data}),e({connected:!0,statusCode:s.statusCode,data:s.data})},fail:s=>{console.error("❌ 后端连接测试失败:",s),e({connected:!1,error:s})}})})}async function R(){const l=`${e().BASE_URL}/documents/upload`;console.log("🔍 测试上传接口:",l);const a=s("token");return new Promise((e,s)=>{t({url:l,method:"OPTIONS",header:{Authorization:a?`Bearer ${a}`:""},timeout:5e3,success:s=>{console.log("✅ 上传接口测试成功:",{statusCode:s.statusCode,headers:s.header}),e({available:!0,statusCode:s.statusCode,headers:s.header})},fail:s=>{console.log("⚠️ 上传接口测试:",s),e({available:!1,error:s})}})})}async function B(l){const a=`${e().BASE_URL}/documents/${l}`;console.log("🔍 检查服务器文件:",a);const o=s("token");return new Promise(e=>{t({url:a,method:"GET",header:{Authorization:o?`Bearer ${o}`:""},timeout:5e3,success:s=>{console.log("✅ 服务器文件检查成功:",s.data),e({exists:!0,data:s.data})},fail:s=>{console.log("❌ 服务器文件检查失败:",s),e({exists:!1,error:s})}})})}const A=l({components:{Sidebar:a},onLoad(){y()},data:()=>({selectedFile:null,selectedDocumentType:"",isDragOver:!1,uploadProgress:0,isProcessing:!1,extractComplete:!1,currentStep:0,processingStep:"正在解析PDF文档...",extractedFieldsCount:0,uploadedFileId:null,extractionTaskId:null,extractionResults:null,progressPollingTimer:null}),methods:{selectDocumentType(e){this.selectedDocumentType=e,this.selectedFile=null,this.uploadProgress=0,this.isProcessing=!1,this.extractComplete=!1,this.currentStep=0,n({title:`已选择：${S[e.toUpperCase()].label}`,icon:"success"})},chooseFile(){this.selectedDocumentType?_({count:1,type:"file",extension:[".pdf"],success:e=>{this.selectedFile={name:e.tempFiles[0].name,size:e.tempFiles[0].size,path:e.tempFiles[0].path,documentType:this.selectedDocumentType},this.uploadFile()},fail:e=>{n({title:"文件选择失败",icon:"none"})}}):n({title:"请先选择文档类型",icon:"none"})},handleDrop(e){e.preventDefault(),this.isDragOver=!1},handleDragOver(e){e.preventDefault(),this.isDragOver=!0},handleDragLeave(e){e.preventDefault(),this.isDragOver=!1},removeFile(){this.selectedFile=null,this.uploadProgress=0,this.isProcessing=!1,this.extractComplete=!1,this.currentStep=0},formatFileSize(e){if(0===e)return"0 B";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["B","KB","MB","GB"][s]},async uploadFile(){var e,s;try{this.uploadProgress=0;const t={description:`${(null==(e=S[this.selectedDocumentType.toUpperCase()])?void 0:e.label)||this.selectedDocumentType}文档上传`,folder:"fund_documents",tags:["基金文档",(null==(s=S[this.selectedDocumentType.toUpperCase()])?void 0:s.label)||this.selectedDocumentType]},l=await g(this.selectedFile.path,this.selectedDocumentType,t,e=>{this.uploadProgress=e});if(console.log("🔍 上传结果详情:",l),console.log("📋 提取到的文档ID:",l.id),!l.id)throw console.error("❌ 上传结果中没有文档ID！"),new Error("上传成功但无法获取文档ID，请重试");if(this.uploadedFileId=l.id,this.selectedFile.id=l.id,this.uploadProgress=100,console.log("✅ 已保存的uploadedFileId:",this.uploadedFileId),!this.uploadedFileId)throw console.error("❌ uploadedFileId保存失败！"),new Error("文档ID保存失败，请重试");n({title:'文件上传成功！请点击"开始提取数据"',icon:"success",duration:3e3}),setTimeout(async()=>{try{console.log("🔍 开始验证文件是否真正上传到后端...");const e=await async function(e){console.log("🚀 开始完整上传验证流程...");const s={backendConnection:await E(),uploadEndpoint:await R(),fileOnServer:e?await B(e):null};return console.log("📋 上传验证结果:",s),s}(this.uploadedFileId);console.log("📋 上传验证完成:",e)}catch(e){console.error("❌ 上传验证失败:",e)}},1e3)}catch(t){console.error("文件上传失败:",t),this.uploadProgress=0,n({title:t.message||"文件上传失败",icon:"none"})}},async startExtract(){var e;if(["fund_contract","custody_agreement","prospectus"].includes(this.selectedDocumentType)){if(console.log("🔍 检查上传状态:",{uploadedFileId:this.uploadedFileId,selectedFile:this.selectedFile,uploadProgress:this.uploadProgress}),!this.uploadedFileId)return console.error("❌ 没有找到uploadedFileId"),void n({title:"请先上传文件",icon:"none"});try{this.isProcessing=!0,this.currentStep=0,this.processingStep="正在启动AI数据提取程序...",u({title:"正在启动提取程序...",mask:!0});const s=await p();if(console.log("🔍 全局配置检查结果:",s),!s.has_global_config)return this.isProcessing=!1,f(),void h({title:"需要配置全局模型",content:"请先在设置页面配置全局模型和API密钥后再进行提取",showCancel:!0,confirmText:"去设置",cancelText:"取消",success:e=>{e.confirm&&r({url:"/pages/settings/settings"})}});console.log("✅ 全局配置检查通过，开始提取"),f(),this.processingStep="正在启动提取任务...";const t={documentType:this.selectedDocumentType,fieldsToExtract:[],mode:"full",extractionDepth:"detailed",priority:"normal",minimumConfidence:.8};console.log("📋 提取配置详情:",t);const l=await m(this.uploadedFileId,t);if(console.log("✅ 提取完成，结果:",l),"COMPLETED"!==l.status)throw new Error("提取未完成，状态："+l.status);this.extractionTaskId=l.id,this.isProcessing=!1,this.extractComplete=!0,this.currentStep=4,this.extractionResults=l,this.extractedFieldsCount=(null==(e=l.extractionSummary)?void 0:e.extractedFields)||0,n({title:"数据提取完成",icon:"success"}),this.verifyHistoryRecord()}catch(s){console.error("启动提取失败:",s),this.isProcessing=!1,f(),s.message&&s.message.includes("配置")?h({title:"配置错误",content:s.message+"\n\n请检查设置页面的全局模型配置",showCancel:!0,confirmText:"去设置",cancelText:"取消",success:e=>{e.confirm&&r({url:"/pages/settings/settings"})}}):n({title:s.message||"启动提取失败",icon:"none"})}}else n({title:"该文档类型暂不支持提取",icon:"none"})},viewResults(){this.extractionResults?(d("currentExtractionResults",this.extractionResults),d("currentTaskId",this.extractionTaskId),r({url:"/pages/results/results"})):r({url:"/pages/results/results"})},async verifyHistoryRecord(){var e,s;try{console.log("🔍 验证历史记录是否已保存..."),console.log("🔍 当前任务信息:",{taskId:this.extractionTaskId,fileName:null==(e=this.selectedFile)?void 0:e.name,documentType:this.selectedDocumentType}),await new Promise(e=>setTimeout(e,2e3));const t=await i({page:1,pageSize:5,documentType:this.selectedDocumentType});if(console.log("📋 最近的历史记录:",t),t&&t.records&&t.records.length>0){const e=t.records.find(e=>{var s;return e.taskId===this.extractionTaskId||e.fileName===(null==(s=this.selectedFile)?void 0:s.name)});e?console.log("✅ 找到历史记录:",e):(console.warn("⚠️ 未找到当前任务的历史记录"),console.warn("⚠️ 查找条件:",{searchTaskId:this.extractionTaskId,searchFileName:null==(s=this.selectedFile)?void 0:s.name,availableRecords:t.records.map(e=>({taskId:e.taskId,fileName:e.fileName}))}),setTimeout(()=>{n({title:"提示：历史记录可能需要几分钟才能显示",icon:"none",duration:3e3})},1e3))}else console.warn("⚠️ 没有获取到任何历史记录")}catch(t){console.error("❌ 验证历史记录失败:",t)}},stopProgressPolling(){this.progressPollingTimer&&(clearInterval(this.progressPollingTimer),this.progressPollingTimer=null,console.log("🛑 已停止进度轮询"))}},onUnload(){this.stopProgressPolling()}},[["render",function(e,s,t,l,a,i){const n=x("Sidebar"),d=v,r=D,u=k;return T(),o(r,{class:"web-layout"},{default:c(()=>[F(n),F(r,{class:"web-content"},{default:c(()=>[F(r,{class:"content-wrapper"},{default:c(()=>[F(r,{class:"page-header fade-in-up"},{default:c(()=>[F(d,{class:"page-title"},{default:c(()=>[P("文件上传")]),_:1}),F(d,{class:"page-subtitle"},{default:c(()=>[P("上传基金发行公告PDF文档，系统将自动提取关键信息")]),_:1})]),_:1}),F(r,{class:"upload-container"},{default:c(()=>[F(r,{class:"document-type-section"},{default:c(()=>[F(r,{class:"section-title"},{default:c(()=>[F(d,{class:"title-text"},{default:c(()=>[P("📋 选择文档类型")]),_:1}),F(d,{class:"title-desc"},{default:c(()=>[P("请先选择要上传的基金公告文档类型")]),_:1})]),_:1}),F(r,{class:"type-cards"},{default:c(()=>[F(r,{class:C(["type-card",{selected:"fund_contract"===a.selectedDocumentType}]),onClick:s[0]||(s[0]=e=>i.selectDocumentType("fund_contract"))},{default:c(()=>[F(r,{class:"type-icon"},{default:c(()=>[P("📄")]),_:1}),F(d,{class:"type-name"},{default:c(()=>[P("基金合同")]),_:1}),F(d,{class:"type-desc"},{default:c(()=>[P("基金合同相关文档")]),_:1}),F(d,{class:"type-fields"},{default:c(()=>[P("提取 44 个字段")]),_:1})]),_:1},8,["class"]),F(r,{class:C(["type-card",{selected:"custody_agreement"===a.selectedDocumentType}]),onClick:s[1]||(s[1]=e=>i.selectDocumentType("custody_agreement"))},{default:c(()=>[F(r,{class:"type-icon"},{default:c(()=>[P("🏦")]),_:1}),F(d,{class:"type-name"},{default:c(()=>[P("托管协议")]),_:1}),F(d,{class:"type-desc"},{default:c(()=>[P("基金托管协议文档")]),_:1}),F(d,{class:"type-fields"},{default:c(()=>[P("提取 22 个字段")]),_:1})]),_:1},8,["class"]),F(r,{class:C(["type-card",{selected:"prospectus"===a.selectedDocumentType}]),onClick:s[2]||(s[2]=e=>i.selectDocumentType("prospectus"))},{default:c(()=>[F(r,{class:"type-icon"},{default:c(()=>[P("📊")]),_:1}),F(d,{class:"type-name"},{default:c(()=>[P("招募说明书")]),_:1}),F(d,{class:"type-desc"},{default:c(()=>[P("基金招募说明书文档")]),_:1}),F(d,{class:"type-fields"},{default:c(()=>[P("提取 22 个字段")]),_:1})]),_:1},8,["class"])]),_:1})]),_:1}),F(r,{class:C(["upload-area",{disabled:!a.selectedDocumentType}])},{default:c(()=>[F(r,{class:C(["upload-card",{"drag-over":a.isDragOver,disabled:!a.selectedDocumentType}]),onDrop:i.handleDrop,onDragover:i.handleDragOver,onDragleave:i.handleDragLeave},{default:c(()=>[F(r,{class:"upload-icon"},{default:c(()=>[F(d,{class:"icon"},{default:c(()=>[P("📄")]),_:1})]),_:1}),F(d,{class:"upload-title"},{default:c(()=>[P(I(a.selectedDocumentType?"拖拽PDF文件到此处或点击选择":"请先选择文档类型"),1)]),_:1}),F(d,{class:"upload-desc"},{default:c(()=>[P(I(a.selectedDocumentType?"支持基金公告PDF文件，最大50MB":"选择文档类型后即可上传文件"),1)]),_:1}),F(u,{class:"select-btn",onClick:i.chooseFile,disabled:!a.selectedDocumentType},{default:c(()=>[F(d,{class:"btn-text"},{default:c(()=>[P("选择文件")]),_:1})]),_:1},8,["onClick","disabled"])]),_:1},8,["class","onDrop","onDragover","onDragleave"])]),_:1},8,["class"]),a.selectedFile?(T(),o(r,{key:0,class:"file-info-section"},{default:c(()=>[F(r,{class:"file-card"},{default:c(()=>[F(r,{class:"file-header"},{default:c(()=>[F(d,{class:"file-name"},{default:c(()=>[P(I(a.selectedFile.name),1)]),_:1}),F(u,{class:"remove-btn",onClick:i.removeFile},{default:c(()=>[P("×")]),_:1},8,["onClick"])]),_:1}),F(r,{class:"file-details"},{default:c(()=>[F(d,{class:"file-size"},{default:c(()=>[P("大小: "+I(i.formatFileSize(a.selectedFile.size)),1)]),_:1}),F(d,{class:"file-type"},{default:c(()=>[P("类型: PDF文档")]),_:1})]),_:1}),a.uploadProgress>0&&a.uploadProgress<100?(T(),o(r,{key:0,class:"progress-section"},{default:c(()=>[F(r,{class:"progress-bar"},{default:c(()=>[F(r,{class:"progress-fill",style:w({width:a.uploadProgress+"%"})},null,8,["style"])]),_:1}),F(d,{class:"progress-text"},{default:c(()=>[P(I(a.uploadProgress)+"%",1)]),_:1})]),_:1})):b("",!0)]),_:1})]),_:1})):b("",!0),a.selectedFile&&100===a.uploadProgress?(T(),o(r,{key:1,class:"extract-section"},{default:c(()=>[F(u,{class:"extract-btn",onClick:i.startExtract,disabled:a.isProcessing},{default:c(()=>[F(d,{class:"btn-text"},{default:c(()=>[P(I(a.isProcessing?"正在启动AI提取程序...":"🚀 开始AI数据提取"),1)]),_:1})]),_:1},8,["onClick","disabled"]),F(r,{class:"extract-tip"},{default:c(()=>[F(d,{class:"tip-text"},{default:c(()=>[P("点击后将启动AI程序，自动提取文档中的关键信息")]),_:1})]),_:1})]),_:1})):b("",!0),a.isProcessing?(T(),o(r,{key:2,class:"processing-section"},{default:c(()=>[F(r,{class:"processing-card"},{default:c(()=>[F(r,{class:"processing-icon"},{default:c(()=>[F(d,{class:"icon"},{default:c(()=>[P("⚙️")]),_:1})]),_:1}),F(d,{class:"processing-title"},{default:c(()=>[P("正在提取数据")]),_:1}),F(d,{class:"processing-desc"},{default:c(()=>[P(I(a.processingStep),1)]),_:1}),F(r,{class:"processing-steps"},{default:c(()=>[F(r,{class:C(["step",{active:a.currentStep>=1}])},{default:c(()=>[F(d,{class:"step-number"},{default:c(()=>[P("1")]),_:1}),F(d,{class:"step-text"},{default:c(()=>[P("解析PDF文档")]),_:1})]),_:1},8,["class"]),F(r,{class:C(["step",{active:a.currentStep>=2}])},{default:c(()=>[F(d,{class:"step-number"},{default:c(()=>[P("2")]),_:1}),F(d,{class:"step-text"},{default:c(()=>[P("识别文本内容")]),_:1})]),_:1},8,["class"]),F(r,{class:C(["step",{active:a.currentStep>=3}])},{default:c(()=>[F(d,{class:"step-number"},{default:c(()=>[P("3")]),_:1}),F(d,{class:"step-text"},{default:c(()=>[P("提取关键信息")]),_:1})]),_:1},8,["class"]),F(r,{class:C(["step",{active:a.currentStep>=4}])},{default:c(()=>[F(d,{class:"step-number"},{default:c(()=>[P("4")]),_:1}),F(d,{class:"step-text"},{default:c(()=>[P("生成结构化数据")]),_:1})]),_:1},8,["class"])]),_:1})]),_:1})]),_:1})):b("",!0),a.extractComplete?(T(),o(r,{key:3,class:"complete-section"},{default:c(()=>[F(r,{class:"complete-card"},{default:c(()=>[F(r,{class:"complete-icon"},{default:c(()=>[F(d,{class:"icon"},{default:c(()=>[P("✅")]),_:1})]),_:1}),F(d,{class:"complete-title"},{default:c(()=>[P("提取完成")]),_:1}),F(d,{class:"complete-desc"},{default:c(()=>[P("成功提取了 "+I(a.extractedFieldsCount)+" 个字段",1)]),_:1}),F(r,{class:"action-buttons"},{default:c(()=>[F(u,{class:"view-btn",onClick:i.viewResults},{default:c(()=>[F(d,{class:"btn-text"},{default:c(()=>[P("查看结果")]),_:1})]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})):b("",!0),F(r,{class:"help-section"},{default:c(()=>[F(d,{class:"help-title"},{default:c(()=>[P("使用说明")]),_:1}),F(r,{class:"help-list"},{default:c(()=>[F(r,{class:"help-item"},{default:c(()=>[F(d,{class:"help-number"},{default:c(()=>[P("1")]),_:1}),F(d,{class:"help-text"},{default:c(()=>[P("上传基金发行公告PDF文件")]),_:1})]),_:1}),F(r,{class:"help-item"},{default:c(()=>[F(d,{class:"help-number"},{default:c(()=>[P("2")]),_:1}),F(d,{class:"help-text"},{default:c(()=>[P("系统自动解析文档内容")]),_:1})]),_:1}),F(r,{class:"help-item"},{default:c(()=>[F(d,{class:"help-number"},{default:c(()=>[P("3")]),_:1}),F(d,{class:"help-text"},{default:c(()=>[P("提取关键信息并结构化")]),_:1})]),_:1}),F(r,{class:"help-item"},{default:c(()=>[F(d,{class:"help-number"},{default:c(()=>[P("4")]),_:1}),F(d,{class:"help-text"},{default:c(()=>[P("查看提取结果")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}],["__scopeId","data-v-0db6a7de"]]);export{A as default};
